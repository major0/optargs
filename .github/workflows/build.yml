name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      optargs-changed: ${{ steps.changes.outputs.optargs }}
      goarg-changed: ${{ steps.changes.outputs.goarg }}
      pflags-changed: ${{ steps.changes.outputs.pflags }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Detect changes
      id: changes
      run: |
        {
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "optargs=true"
            echo "goarg=true"
            echo "pflags=true"
          else
            CHANGED=$(git diff --name-only HEAD~1 2>/dev/null || echo "")
            if echo "$CHANGED" | grep -qE '^[^/]+\.(go|mod|sum)$'; then
              echo "optargs=true"
            else
              echo "optargs=false"
            fi
            if echo "$CHANGED" | grep -qE '^(goarg/|[^/]+\.(go|mod|sum)$)'; then
              echo "goarg=true"
            else
              echo "goarg=false"
            fi
            if echo "$CHANGED" | grep -qE '^(pflags/|[^/]+\.(go|mod|sum)$)'; then
              echo "pflags=true"
            else
              echo "pflags=false"
            fi
          fi
        } >> "$GITHUB_OUTPUT"

  build-optargs:
    name: Build OptArgs Core
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.optargs-changed == 'true'
    strategy:
      matrix:
        go-version: ['1.23']
        goos: [linux, darwin, windows, freebsd]
        goarch: [amd64, arm64]
        exclude:
          - goos: freebsd
            goarch: arm64
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
    - run: go mod download
    - run: go mod verify
    - run: go build -v ./...
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}

  build-goarg:
    name: Build GoArg Module
    runs-on: ubuntu-latest
    needs: [detect-changes, build-optargs]
    if: always() && needs.detect-changes.outputs.goarg-changed == 'true'
    strategy:
      matrix:
        go-version: ['1.23']
        goos: [linux, darwin, windows, freebsd]
        goarch: [amd64, arm64]
        exclude:
          - goos: freebsd
            goarch: arm64
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
    - run: go mod download
      working-directory: goarg
    - run: go mod verify
      working-directory: goarg
    - run: go build -v ./...
      working-directory: goarg
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}

  build-pflags:
    name: Build PFlags Module
    runs-on: ubuntu-latest
    needs: [detect-changes, build-optargs]
    if: always() && needs.detect-changes.outputs.pflags-changed == 'true'
    strategy:
      matrix:
        go-version: ['1.23']
        goos: [linux, darwin, windows, freebsd]
        goarch: [amd64, arm64]
        exclude:
          - goos: freebsd
            goarch: arm64
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
    - run: go mod download
      working-directory: pflags
    - run: go mod verify
      working-directory: pflags
    - run: go build -v ./...
      working-directory: pflags
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
